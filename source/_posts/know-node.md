---
title: äº†è§£ Node
date: 2021-09-26 23:09:13
tags:
  - nodejs
---

## å‰è¨€

æ–°äººè®­ç»ƒè¥ä»¥æ ‘ç¥çš„ node åˆ†äº«ä½œä¸ºå‹è½´èŠ‚ç›® ğŸ‘ğŸ‘
æˆ‘æ¥æ•´ç¯‡ç¬”è®° ğŸ“’ ï½

## å®šä¹‰

ä¸‡äº‹ä¸‡ç‰©éƒ½éœ€è¦ä¸€ä¸ªå®šä¹‰ã€‚é‚£ä¹ˆ nodejs æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ
nodejs æ˜¯ javascript çš„ä¸€ä¸ªè¿è¡Œç¯å¢ƒã€‚æµè§ˆå™¨ä¹Ÿæ˜¯ js è¿è¡Œç¯å¢ƒï¼Œä½†æ˜¯ä½œä¸ºä¸€ä¸ªæ²™ç›’ç¯å¢ƒï¼Œå®ƒä¸æœ¬æœºç¯å¢ƒéš”ç¦»ï¼Œè€Œ node åˆ™ä½äºæœåŠ¡ç«¯ã€‚
è®©æˆ‘ä»¬æ¥æƒ³æƒ³ï¼Œå½“ä¸€ä¸ªè¯­è¨€ç”¨æ¥åšæœåŠ¡å™¨ç«¯ä½¿ç”¨è¯­è¨€ï¼Œé‚£ä¹ˆå®ƒè¯¥åšäº›ä»€ä¹ˆå‘¢ï¼Ÿç½‘ç»œè¯·æ±‚/å¤„ç†ã€æ–‡ä»¶ IOï¼ˆè¯»å†™ï¼‰ã€æ•°æ®åº“æŸ¥å†™ï¼Œæˆ–å…¶å®ƒã€‚
ä¼—æ‰€å‘¨çŸ¥ï¼Œjs åœ¨æµè§ˆå™¨æ˜¯æ²¡æœ‰æƒé™è¯»å–æ–‡ä»¶çš„ï¼Œé‚£ä¹ˆä¸º web è€Œç”Ÿçš„ js ï¼Œè¯¥å¦‚ä½•è¿è¡Œåœ¨æœåŠ¡å™¨ç«¯å‘¢ï¼Ÿè¯·çœ‹å®ƒçš„æ¶æ„ã€‚

## æ¶æ„

æ¶æ„å›¾å¦‚ä¸‹ï¼š
![node æ¶æ„](/images/node/structure.png)

node ä½¿ç”¨ chrome çš„ V8 å¼•æ“æ¥æä¾›è§£é‡Šæ‰§è¡Œ JS çš„èƒ½åŠ›ï¼ŒåŸºäº C/C++ æ¥å®ç°æœåŠ¡å™¨ç«¯èƒ½åŠ›ã€‚

æ³¨æ„ V8 æä¾›çš„ä»…æ˜¯ JS åŸç”Ÿè¯­æ³•çš„è§£é‡Šæ‰§è¡Œï¼Œè€Œä¸æµè§ˆå™¨ç›¸å…³çš„åŠŸèƒ½ï¼Œå¦‚ BOM å’Œ DOMï¼Œå¹¶ä¸æ¶‰åŠã€‚
å¯¹äºæœåŠ¡å™¨ç«¯èƒ½åŠ›ï¼Œå…¶ä¸­çš„ç½‘ç»œã€æ–‡ä»¶æ“ä½œç›¸å…³èƒ½åŠ›ï¼Œç”± [libuv](https://github.com/libuv/libuv) æä¾›ã€‚

libuv æ˜¯ä¸€ä¸ªå¤šå¹³å° C åº“ï¼Œæä¾›å¯¹åŸºäºäº‹ä»¶å¾ªç¯çš„å¼‚æ­¥ I/O çš„æ”¯æŒï¼Œæœ‰å¦‚ä¸‹èƒ½åŠ›ï¼š

- ç”± epollã€kqueueã€IOCPã€äº‹ä»¶ç«¯å£æ”¯æŒçš„å…¨åŠŸèƒ½ **äº‹ä»¶å¾ªç¯**
- å¼‚æ­¥ TCP å’Œ UDP å¥—æ¥å­—
- å¼‚æ­¥ DNS è§£æ
- å¼‚æ­¥æ–‡ä»¶å’Œæ–‡ä»¶ç³»ç»Ÿæ“ä½œ
- æ–‡ä»¶ç³»ç»Ÿäº‹ä»¶
- ANSI è½¬ä¹‰åºåˆ—æ§åˆ¶çš„ TTY
- IPC ç»ç”±å¥—æ¥å­—å…±äº«ï¼Œä½¿ç”¨ Unix åŸŸå¥—æ¥å­—æˆ–å‘½åç®¡é“ï¼ˆWindowsï¼‰
- å­è¿›ç¨‹
- çº¿ç¨‹æ± 
- çº¿ç¨‹å’ŒåŒæ­¥åŸè¯­ï¼ˆprimitiveï¼‰
- ä¿¡å·å¤„ç†
- é«˜æ¸…æ™°åº¦æ—¶é’Ÿ

åŒæ—¶ï¼Œè¿˜æœ‰ä¸€äº›å…¶å®ƒçš„ C++ æ¨¡å—ï¼Œå¦‚ Buffer/Cryptoï¼Œåˆ™ä¸ä¾èµ– linuvï¼Œä¸º node è‡ªè¡Œå®ç°ã€‚

> node è¿˜å…è®¸å¼€å‘è€…è‡ªå®šä¹‰ C++ æ‰©å±•ã€‚è‹¥æœ‰å…´è¶£ï¼Œå¯è§ï¼ˆå¼ºå¦‚ï¼‰æ­»æœˆå†™çš„ã€Šæ¥ä¸€æ‰“ C++ æ‰©å±•ã€‹

## å¯åŠ¨æµç¨‹

## äº‹ä»¶å¾ªç¯

ç¤ºæ„å›¾å¦‚ä¸‹ï¼š
![node äº‹ä»¶å¾ªç¯](/images/node/event-loop.png)

### è¿è¡Œæµç¨‹

Node çš„è¿è¡Œæµç¨‹å¦‚ä¸‹ï¼š

1. V8 å¼•æ“è§£æ JavaScript è„šæœ¬ã€‚
2. è§£æå¤„ç†æä¾›çš„è„šæœ¬åï¼Œè°ƒç”¨ Node APIã€‚
3. libuv åº“è´Ÿè´£ Node API çš„æ‰§è¡Œã€‚å®ƒå°†ä¸åŒçš„ä»»åŠ¡åˆ†é…ç»™ä¸åŒçš„çº¿ç¨‹ï¼Œå½¢æˆä¸€ä¸ª Event Loopï¼ˆäº‹ä»¶å¾ªç¯ï¼‰ï¼Œä»¥å¼‚æ­¥çš„æ–¹å¼å°†ä»»åŠ¡çš„æ‰§è¡Œç»“æœè¿”å›ç»™ V8 å¼•æ“ã€‚
4. V8 å¼•æ“å†å°†ç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚

æ‰€ä»¥è¯´ï¼Œäº‹ä»¶å¾ªç¯æ˜¯ Node å¤„ç†éé˜»å¡ I/O æ“ä½œçš„æœºåˆ¶ï¼Œäº‹ä»¶å¾ªç¯ç‰¹æ€§ç”± libuv å®ç°ã€‚

JS æ˜¯å•çº¿ç¨‹å¤„ç†çš„ï¼Œä½†æœ‰æ—¶å€™ï¼Œå®ƒä»¬ä¼šæŠŠæ“ä½œè½¬ç§»åˆ°ç³»ç»Ÿå†…æ ¸ä¸­å»ã€‚
ç›®å‰å¤§å¤šæ•°å†…æ ¸éƒ½æ˜¯å¤šçº¿ç¨‹çš„ï¼Œå®ƒä»¬å¯åœ¨åå°å¤„ç†å¤šç§æ“ä½œã€‚å½“å…¶ä¸­çš„ä¸€ä¸ªæ“ä½œå®Œæˆçš„æ—¶å€™ï¼Œå†…æ ¸é€šçŸ¥ Node å°†é€‚åˆçš„å›è°ƒå‡½æ•°æ·»åŠ åˆ° è½®è¯¢ é˜Ÿåˆ—ä¸­ç­‰å¾…æ—¶æœºæ‰§è¡Œã€‚

ä¾‹å¦‚æ–‡ä»¶ IOï¼Œä¸»çº¿ç¨‹ä¼šç›´æ¥æŠŠè¯¥ä»»åŠ¡ç»™ libuv ï¼Œè‡ªå·±å»æ‰§è¡Œå…¶å®ƒä»»åŠ¡ï¼Œlibuv é»˜è®¤æœ‰ 4 ä¸ªçº¿ç¨‹ï¼Œå½“ libuv æ‰§è¡Œå®Œè¯¥ä»»åŠ¡åï¼Œå†æŠŠç»“æœè¿”å›ç»™ä¸»çº¿ç¨‹ã€‚

å…¶ä¸­ libuv å¼•æ“ä¸­çš„äº‹ä»¶å¾ªç¯åˆ†ä¸º 6 ä¸ªé˜¶æ®µï¼Œå®ƒä»¬ä¼šæŒ‰ç…§é¡ºåºåå¤è¿è¡Œã€‚
æ¯å½“è¿›å…¥æŸä¸€ä¸ªé˜¶æ®µçš„æ—¶å€™ï¼Œéƒ½ä¼šä»å¯¹åº”çš„å›è°ƒé˜Ÿåˆ—ä¸­å–å‡ºå‡½æ•°å»æ‰§è¡Œã€‚å½“é˜Ÿåˆ—ä¸ºç©ºæˆ–è€…æ‰§è¡Œçš„å›è°ƒå‡½æ•°æ•°é‡åˆ°è¾¾ç³»ç»Ÿè®¾å®šçš„é˜ˆå€¼ï¼Œå°±ä¼šè¿›å…¥ä¸‹ä¸€é˜¶æ®µã€‚

### 6 ä¸ªé˜¶æ®µ

è¿™é‡Œæ˜¯ 6 ä¸ªé˜¶æ®µï¼š

- timer **å®šæ—¶å™¨**ï¼šæœ¬é˜¶æ®µæ‰§è¡Œå·²ç»åˆ°ç‚¹çš„ **setTimeout()** å’Œ **setInterval()** çš„**è°ƒåº¦å›è°ƒå‡½æ•°**ã€‚
- å¾…å®šå›è°ƒï¼šå¤„ç†ä¸€äº›ä¸Šä¸€è½®å¾ªç¯ä¸­çš„å°‘æ•°æœªæ‰§è¡Œçš„ I/O å›è°ƒã€‚
- idle, prepareï¼šä»… node å†…éƒ¨ä½¿ç”¨ã€‚
- poll **è½®è¯¢**ï¼š
  - æ£€ç´¢æ–°çš„ I/O äº‹ä»¶ï¼›
  - æ‰§è¡Œä¸ I/O ç›¸å…³çš„å›è°ƒï¼ˆå‡ ä¹æ‰€æœ‰æƒ…å†µä¸‹ï¼Œé™¤äº†å…³é—­çš„å›è°ƒå‡½æ•°ï¼Œé‚£äº›ç”±è®¡æ—¶å™¨å’Œ setImmediate() è°ƒåº¦çš„ä¹‹å¤–ï¼‰ï¼Œå…¶ä½™æƒ…å†µ node å°†åœ¨é€‚å½“çš„æ—¶å€™åœ¨æ­¤é˜»å¡ã€‚
- check æ£€æµ‹ï¼š**setImmediate()** å›è°ƒå‡½æ•°åœ¨è¿™é‡Œæ‰§è¡Œã€‚
- å…³é—­çš„å›è°ƒå‡½æ•°ï¼šä¸€äº›å…³é—­çš„å›è°ƒå‡½æ•°ï¼Œå¦‚ï¼šsocket.on('close', ...)ã€‚

æ¥ä¸‹å»è¯¦ç»†ä»‹ç» timersã€pollã€check è¿™ 3 ä¸ªé˜¶æ®µï¼Œå› ä¸ºæ—¥å¸¸å¼€å‘ä¸­çš„ç»å¤§éƒ¨åˆ†å¼‚æ­¥ä»»åŠ¡éƒ½æ˜¯åœ¨è¿™ 3 ä¸ªé˜¶æ®µå¤„ç†çš„ã€‚

1. timer
   timers é˜¶æ®µä¼šæ‰§è¡Œ setTimeout å’Œ setInterval å›è°ƒï¼Œå¹¶ä¸”æ˜¯ç”± poll é˜¶æ®µæ§åˆ¶çš„ã€‚
   åŒæ ·ï¼Œåœ¨ Node ä¸­å®šæ—¶å™¨æŒ‡å®šçš„æ—¶é—´ä¹Ÿä¸æ˜¯å‡†ç¡®æ—¶é—´ï¼Œåªèƒ½æ˜¯å°½å¿«æ‰§è¡Œã€‚

2. poll
   poll æ˜¯ä¸€ä¸ªè‡³å…³é‡è¦çš„é˜¶æ®µï¼Œè¿™ä¸€é˜¶æ®µä¸­ï¼Œç³»ç»Ÿä¼šåšä¸¤ä»¶äº‹æƒ…ï¼š**å›åˆ° timer é˜¶æ®µæ‰§è¡Œå›è°ƒ**ï¼Œå’Œ**æ‰§è¡Œ I/O å›è°ƒ**ã€‚
   å¦‚æœ**è®¾å®šäº† timer çš„è¯ä¸” poll é˜Ÿåˆ—ä¸ºç©º**ï¼Œåˆ™ä¼šåˆ¤æ–­æ˜¯å¦æœ‰ timer è¶…æ—¶ï¼Œå¦‚æœæœ‰çš„è¯ä¼šå›åˆ° timer é˜¶æ®µæ‰§è¡Œå›è°ƒã€‚
   å¦‚æœè¿›å…¥è¯¥é˜¶æ®µæ—¶æ²¡æœ‰è®¾å®š timer ï¼š

   - è‹¥ poll é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œä¼šéå†å›è°ƒé˜Ÿåˆ—å¹¶åŒæ­¥æ‰§è¡Œï¼Œç›´åˆ°é˜Ÿåˆ—ä¸ºç©ºæˆ–è€…è¾¾åˆ°ç³»ç»Ÿé™åˆ¶
   - è‹¥ poll é˜Ÿåˆ—ä¸ºç©ºï¼š

     - è‹¥æœ‰ setImmediate å›è°ƒéœ€æ‰§è¡Œï¼Œè¿›å…¥ check é˜¶æ®µ
     - è‹¥æ—  setImmediate å›è°ƒéœ€æ‰§è¡Œï¼Œä¼šç­‰å¾…å›è°ƒè¢«åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­å¹¶ç«‹å³æ‰§è¡Œå›è°ƒï¼Œè¿™é‡ŒåŒæ ·ä¼šæœ‰ä¸ªè¶…æ—¶æ—¶é—´è®¾ç½®é˜²æ­¢ä¸€ç›´ç­‰å¾…ä¸‹å»

3. check

setImmediate()çš„å›è°ƒä¼šè¢«åŠ å…¥ check é˜Ÿåˆ—ä¸­ï¼Œcheck é˜¶æ®µçš„æ‰§è¡Œé¡ºåºåœ¨ poll é˜¶æ®µä¹‹åã€‚

çœ‹ä¸€ä¸ªä¾‹å­ï¼š

```js
console.log('start');
setTimeout(() => {
  console.log('timer1');
  Promise.resolve().then(function () {
    console.log('promise1');
  });
}, 0);
setTimeout(() => {
  console.log('timer2');
  Promise.resolve().then(function () {
    console.log('promise2');
  });
}, 0);
Promise.resolve().then(function () {
  console.log('promise3');
});
console.log('end');
```

è¾“å‡ºç»“æœæ˜¯ï¼š

```js
//start=>end=>promise3=>timer1=>timer2=>promise1=>promise2
```

ä¸€å¼€å§‹æ‰§è¡Œæ ˆçš„åŒæ­¥ä»»åŠ¡ï¼ˆè¿™å±äºå®ä»»åŠ¡ï¼‰æ‰§è¡Œå®Œæ¯•åï¼ˆä¾æ¬¡æ‰“å°å‡º start endï¼Œå¹¶å°† 2 ä¸ª timer ä¾æ¬¡æ”¾å…¥ timer é˜Ÿåˆ—ï¼‰,ä¼šå…ˆå»æ‰§è¡Œå¾®ä»»åŠ¡ï¼ˆè¿™ç‚¹è·Ÿæµè§ˆå™¨ç«¯çš„ä¸€æ ·ï¼‰ï¼Œæ‰€ä»¥æ‰“å°å‡º promise3

ç„¶åè¿›å…¥ timers é˜¶æ®µï¼Œæ‰§è¡Œ timer1 çš„å›è°ƒå‡½æ•°ï¼Œæ‰“å° timer1ï¼Œå¹¶å°† promise.then å›è°ƒæ”¾å…¥ microtask é˜Ÿåˆ—ï¼ŒåŒæ ·çš„æ­¥éª¤æ‰§è¡Œ timer2ï¼Œæ‰“å° timer2ï¼›è¿™ç‚¹è·Ÿæµè§ˆå™¨ç«¯ç›¸å·®æ¯”è¾ƒå¤§ï¼Œtimers é˜¶æ®µæœ‰å‡ ä¸ª setTimeout/setInterval éƒ½ä¼šä¾æ¬¡æ‰§è¡Œï¼Œå¹¶ä¸åƒæµè§ˆå™¨ç«¯ï¼Œæ¯æ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡åå°±å»æ‰§è¡Œä¸€ä¸ªå¾®ä»»åŠ¡ã€‚

### process.nextTick

è¿™ä¸ªå‡½æ•°å…¶å®æ˜¯ç‹¬ç«‹äº Event Loop ä¹‹å¤–çš„ï¼Œå®ƒæœ‰ä¸€ä¸ªè‡ªå·±çš„é˜Ÿåˆ—ï¼Œå½“æ¯ä¸ªé˜¶æ®µå®Œæˆåï¼Œå¦‚æœå­˜åœ¨ nextTick é˜Ÿåˆ—ï¼Œå°±ä¼šæ¸…ç©ºé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å›è°ƒå‡½æ•°ï¼Œå¹¶ä¸”ä¼˜å…ˆäºå…¶ä»– microtask æ‰§è¡Œã€‚

```js
setTimeout(() => {
  console.log('timer1');
  Promise.resolve().then(function () {
    console.log('promise1');
  });
}, 0);
process.nextTick(() => {
  console.log('nextTick');
  process.nextTick(() => {
    console.log('nextTick');
    process.nextTick(() => {
      console.log('nextTick');
      process.nextTick(() => {
        console.log('nextTick');
      });
    });
  });
});
// nextTick=>nextTick=>nextTick=>nextTick=>timer1=>promise1
```

### Node ä¸æµè§ˆå™¨çš„ Event Loop å·®å¼‚

æµè§ˆå™¨ç¯å¢ƒä¸‹ï¼Œmicrotask çš„ä»»åŠ¡é˜Ÿåˆ—æ˜¯æ¯ä¸ª macrotask æ‰§è¡Œå®Œä¹‹åæ‰§è¡Œã€‚è€Œåœ¨ Node.js ä¸­ï¼Œmicrotask ä¼šåœ¨äº‹ä»¶å¾ªç¯çš„å„ä¸ªé˜¶æ®µä¹‹é—´æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªé˜¶æ®µæ‰§è¡Œå®Œæ¯•ï¼Œå°±ä¼šå»æ‰§è¡Œ microtask é˜Ÿåˆ—çš„ä»»åŠ¡ã€‚

## å‚è€ƒ

- [node äº‹ä»¶å¾ªç¯](https://nodejs.org/zh-cn/docs/guides/event-loop-timers-and-nexttick/)
